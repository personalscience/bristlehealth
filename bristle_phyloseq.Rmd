---
title: "Bristle and Phyloseq"
author: "Richard Sprague"
date: "`r Sys.Date()`"
output:
  github_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(phyloseq)
library(psmr)  # use library function instead.
if(!require("bristler")) devtools::install_github("personalscience/bristler")


```

## Read Bristle sample data

```{r}

bristle_data <-bristler::read_bristle_table(filepath=file.path("data/BristleHealthRaw.xlsx"))

```

## Create a mapfile

Experiment dataframe with the following exact column names (additional columns are okay but will be ignored):

-    "ssr": sequencing revision, aka sample ID number (e.g. 42578). Your column probably repeats many SSRs.

-   "tax_name": (e.g. "Bifidobacterium").

-   "count" : reads for that taxa at that SSR (e.g. 2137)

-   Mapping file: a dataframe that contains: "ssr": exact same SSRs as experiment dataframe above attributes columns: as many as you like. (e.g. "yogurteater", "geo", "kefireater", "gender")

```{r}

bristle_data$ssr <- 1234
mapfile <- tibble(ssr=1234,label="baseline")

```

## Make the Phyloseq object

```{r}

e.ps <- bristler::phyloseqize(bristle_data, mapfile = mapfile)
phyloseq::sample_names(e.ps) <- "baseline"
phyloseq::sample_names(map.data.ps) <- map.data$SSR

```

```{r}
plot_bar(e.ps, fill = "Genus")
plot_heatmap(e.ps, method = "CCA", distance = "none",fill = "Genus")

```

Now attempt other Phyloseq operations.

```{r}

estimate_richness(e.ps, measures = c("InvSimpson","Shannon"))

plot_richness(e.ps, measures = c("InvSimpson","Shannon"))


```

## Additional objects

Create more Bristle objects and then merge them with `merge_phyloseq()`

```{r}

am_sample <- bristler::read_bristle_table(filepath=file.path("data", "Bristle-2022-08-02-AM.xlsx"))
am_sample$ssr <- 1235
am_mapfile <- tibble(ssr=1235,label="AM")
phyloseq::sample_names(am.ps) <- "AM"
am.ps <- bristler::phyloseqize(am_sample,am_mapfile)


  
pm_sample <- bristler::read_bristle_table(filepath=file.path("data", "Bristle-2022-08-02-PM.xlsx"))
pm_sample$ssr <- 1236
pm_mapfile <- tibble(ssr=1236,label="PM")

pm.ps <- bristler::phyloseqize(pm_sample, pm_mapfile)
phyloseq::sample_names(pm.ps) <- "PM"

all_samples <- phyloseq::merge_phyloseq(e.ps, am.ps, pm.ps)

```


## NMDS
```{r}

all_samples.ord <- phyloseq::ordinate(all_samples, method = "PCoA")
phyloseq::plot_ordination(all_samples, all_samples.ord,
                          title = "PCoA for All Samples",
                          label = "")


```

